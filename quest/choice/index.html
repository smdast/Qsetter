<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>qsetter</title>
  </head>
  <header style="display: flex;">
    <svg viewBox="0 -960 960 960" id="back" style="width: 28px; margin:0px 10px; cursor: pointer;" fill="#e3e3e3"><path d="m313-440 224 224-57 56-320-320 320-320 57 56-224 224h487v80H313Z"/></svg>
    <div style="font-size: 1.4rem;">出題中</div>
    <md-linear-progress id="progressbar" style="align-self: center; min-width: 0px; margin-left: 20px; margin-right: 20px; flex: 1;" determinate></md-linear-progress> 
    <div id="head" style="font-size: 1.2rem; margin-right: 30px;">##問目 / ##問</div>
  </header>
  <body>
    <div style="margin: 10px;"><pre class="questionTxt" id="question">問題文</pre></div>
    
    <div class="choicebox">
        <md-filled-button class="choices">選択肢１</md-filled-button>
        <md-filled-button class="choices">選択肢２</md-filled-button>
        <md-filled-button class="choices">選択肢３</md-filled-button>
        <md-filled-button class="choices">選択肢４</md-filled-button>
    </div>

    <md-dialog id="answerdialog">
      <div slot="headline">
        Dialog title
      </div>
      <form slot="content" id="form-id" method="dialog">
        <div class="expander" style="margin-top: 10px;">
          <hr style="margin: 0px;"/>
          <div id="summary" style="font-size: 1.1rem; margin: 0px; padding: 10px; display: flex; align-items: center; cursor: pointer;">
            <div id="summarytxt">解答を表示</div>
            <svg 
              id="arrow" 
              viewBox="0 -960 960 960"
              style="width: 28px; margin-left: auto; cursor: pointer; transition: transform 0.25s ease; transform-origin: center;">
              <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
            </svg>
          </div>
          <pre id="details" class="box" style="margin: 0px;">ダミーテキスト</pre>
          <hr style="margin: 0px;"/>
        </div>
      </form>
      <div slot="actions">
        <md-text-button id="retry" form="form-id">もう一度</md-text-button>
        <md-filled-button id="next" form="form-id">次へ</md-filled-button>
      </div>
    </md-dialog>
    <script type="module" src="/src/main.js"></script>
    <script>
      // ページ読み込み時にquestionDataがなければホームにリダイレクト
    //   document.addEventListener('DOMContentLoaded', () => {
    //     if (sessionStorage.getItem('questionData') === null) {
    //       window.location.href = '/';
    //       console.log('No question data found, redirecting to home.');
    //     }
    //     document.getElementById('answerfield').focus();
    //   });

      // 出題処理
      const questionData = JSON.parse(sessionStorage.getItem('questionData'));
      const qn = parseInt(new URLSearchParams(window.location.search).get('qn'));
      document.getElementById('question').textContent = questionData[qn - 1][0].replace(/\\n/g, "\n");
      document.getElementById("head").textContent = `${qn}問目 / ${questionData.length}問`;
      document.getElementById("progressbar").value = (qn - 1) / questionData.length;
      const choices = document.querySelectorAll('.choices');
      const correctAnswer = questionData[qn - 1][1].trim();
      const answers = questionData.map(row => row[1]);
      answers.splice(answers.indexOf(correctAnswer), 1);
      answers.sort(() => Math.random() - 0.5);
      const choiceAnswers = [...answers.slice(0, 3)];
      choiceAnswers.splice(Math.floor(Math.random() * 4), 0, correctAnswer);
        for (let i = 0; i < choices.length; i++) {
            choices[i].textContent = choiceAnswers[i];
            choices[i].addEventListener('click', async (event) => {
                let wrongnumbers = sessionStorage.getItem('wrongnumbers') ? JSON.parse(sessionStorage.getItem('wrongnumbers')) : [];
                const userAnswer = event.currentTarget.textContent.trim();
                let correct = (userAnswer == correctAnswer);
                if (!correct) {
                  wrongnumbers.push([[qn - 1],[userAnswer]]);
                  sessionStorage.setItem('wrongnumbers', JSON.stringify(wrongnumbers));
                }
                const dialog = document.querySelector('md-dialog');
                dialog.querySelector('[slot="headline"]').textContent = correct ? '正解！' : '不正解';
                document.getElementById("details").textContent = `${correctAnswer}\nあなたの答え: ${userAnswer}`;
                document.getElementById('retry').style.display = correct ? 'none' : 'inline-block';
                await dialog.show();
                document.getElementById('next').focus();
            });
        }

      // 各種ボタン処理
      document.getElementById('next').addEventListener('click', () => {
        const nextQn = qn + 1;
        if (nextQn > questionData.length) {
          window.location.href = '/Qsetter/quest/result/?form=choice';
        } else {
          const params = new URLSearchParams();
          params.append('qn', nextQn.toString());
          window.location.href = `/Qsetter/quest/choice/?${params.toString()}`;
        }
      });

      document.getElementById('retry').addEventListener('click', async () => {
        const dialog = document.querySelector('md-dialog');
        await dialog.close();
      });
      document.querySelector("md-dialog").addEventListener("keydown", (event) => {
        console.log(event.key);
        if (event.key === 'Shift') {
          event.preventDefault();
          document.getElementById('summary').click();
        }
      });

      document.getElementById('back').addEventListener('click', () => {
        if (confirm('途中で終了すると、これまでの成績は保存されません。本当に終了しますか？', '確認', 'はい', 'いいえ')) {
          sessionStorage.clear();
          window.location.href = '/Qsetter/';
        }
      });

      document.getElementById('summary').addEventListener('click', () => {
        const details = document.getElementById('details');
        const open = !details.classList.contains("show");
        document.getElementById("arrow").style.transform = open ? "rotate(180deg)" : "rotate(0deg)";
        details.classList.toggle("show");
        document.getElementById("summarytxt").textContent = open ? "解答を隠す" : "解答を表示";
      });
    </script>
  </body>
</html>
